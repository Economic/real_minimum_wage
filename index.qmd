---
title: ""
execute:
  echo: false
format:
  html:
    theme: cosmo
    mainfont: proxima-nova, sans-serif
    fig-width: 8
    fig-height: 4
    fig-dpi: 300
---

```{r}
#| include: false
library(tidyverse)
library(lubridate)
library(tsibble)
library(zoo)
library(hrbrthemes)
library(cowplot)
library(ggtext)
library(here)

# necessary for cowplot
set_null_device("png")

fed_mw <- read_csv(here("data", "raw", "fed_min_wage.csv")) %>% 
  mutate(date = yearmonth(mdy(date))) %>% 
  add_row(date = yearmonth("2022m6"), fed_min_wage = 7.25) %>% 
  as_tsibble(index = date) %>% 
  fill_gaps() %>% 
  arrange(date) %>% 
  fill(fed_min_wage, .direction = "down") %>% 
  select(date, nominal_fed_mw = fed_min_wage) 

# created by create_cpi.R
cpi <- read_csv(here("data", "processed", "cpi_u_rs_extended.csv")) %>% 
  mutate(date = yearmonth(date)) 

cpi_base <- cpi %>% 
  filter(date == yearmonth("June 2022")) %>% 
  pull(cpi_u_rs_sa_extended)

real_fed_mw <- fed_mw %>% 
  full_join(cpi, by = "date") %>% 
  mutate(real_fed_mw = nominal_fed_mw * cpi_base / cpi_u_rs_sa_extended) %>% 
  filter(date >= yearmonth("1938m10")) %>% 
  select(date, real_fed_mw, nominal_fed_mw) 

date_breaks <- tribble(
  ~date, ~date_label, ~date_hjust, ~date_description,
  ym("1938m10"), "Oct. 1938", 0, NA,
  ym("1968m2"), "Feb. 1968", 0.5, "Peak value", 
  ym("2009m7"), "July 2009", 0.5, "Last increase",
  ym("2022m6"), "July 2022", 1, "Today"
)

line_graph_data <- real_fed_mw %>% 
  # easier to graph with Date data
  mutate(date = ym(date)) %>% 
  full_join(date_breaks, by = "date") %>% 
  mutate(
    date_break = if_else(!is.na(date_label), date, NA_real_),
    date_value = if_else(!is.na(date_label), real_fed_mw, NA_real_),
    date_value = round(date_value, 2),
    date_value_string = if_else(!is.na(date_value),paste0("$", date_value), "")
  )

bar_graph_data <- line_graph_data %>% 
  filter(!is.na(date_description)) %>% 
  mutate(date_year = year(date)) %>% 
  mutate(date_description = case_when(
    date_year == 1968 ~ "Peak value of minimum wage",
    date_year == 2009 ~ "Last minimum wage increase",
    date_year == 2022 ~ "Today"
  )) %>% 
  mutate(date_value_string = case_when(
    date_year == 1968 ~ paste0(date_value_string, "/hr"),
    TRUE ~ date_value_string
  )) %>% 
  mutate(
    annual_value_string = prettyNum(round(date_value*2080), big.mark=","),
    date_value_string = paste0("**", date_value_string, "**"),
    date_value_string = paste0(date_value_string, " ($", annual_value_string, ")")
  ) %>% 
  arrange(date) %>% 
  mutate(display_order = row_number())
```

#### Real value of the minimum wage (adjusted for inflation)

```{r}
### After the longest period in history without an increase, the federal minimum wage today is worth XX% less than 13 years ago--and 40% less than in 1968 

my_theme <- function(){
  theme_ipsum() +
  theme(
        text = element_text(family = "Proxima Nova Rg"),
        plot.margin = margin(
          t = 5, 
          r = 5,
          b = 5, 
          l = 5, 
          unit = "pt"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none"
  )
}

p1 <- line_graph_data %>% 
  ggplot() +
  geom_segment(
    aes(
      x = date_break, 
      xend = date_break, 
      y = 3.75, 
      yend = 14
    ),
    color = "grey80",
    linetype = "dashed",
    na.rm = TRUE
  ) +
  geom_line(
    aes(x = date, y = real_fed_mw), 
    data = filter(line_graph_data, date <= ym("2009m7")),
    size = 1.5,
    color = "#1273af",
    lineend = "round"
  ) +
  geom_line(
    aes(x = date, y = real_fed_mw), 
    data = filter(line_graph_data, date >= ym("2009m7")),
    size = 1.5,
    color = "#c01f41",
    lineend = "round"
  ) +
  my_theme() +
  scale_x_date(
    breaks = NULL,
    minor_breaks = NULL
  ) +
  scale_y_continuous(
    breaks = c(6, 8, 10, 12),
    minor_breaks = NULL,
    labels = scales::label_dollar()
  ) +
  coord_cartesian(
    xlim = c(ym("1938m1"), ym("2022m7")), 
    ylim = c(3, 13.75),
    expand = FALSE
  ) +
  geom_text(
    aes(
      x = date, 
      y = 3.5, 
      label = date_label, 
      hjust = date_hjust
    ),
    na.rm = TRUE,
    color = "grey40",
    family = "Proxima Nova Rg"
  ) +
  geom_text(
    aes(
      x = date, 
      y = 13.5, 
      label = date_value_string, 
    ),
    hjust = 1,
    nudge_x = -300,
    na.rm = TRUE,
    color = "#2b2b2b",
    family = "Proxima Nova Rg",
    fontface = "bold"
  ) +
  geom_text(
    aes(
      x = date, 
      y = 13, 
      label = date_description
    ),
    hjust = 1,
    nudge_x = -300,
    na.rm = TRUE,
    color = "grey40",
    family = "Proxima Nova Rg"
  ) +
  annotate(
    "text", 
    x = ym("1938m10") + 300, 
    y = 13.5, 
    label = "Minimum wage",
    color = "grey40",
    family = "Proxima Nova Rg",
    hjust = 0
  ) + 
  annotate(
    "text", 
    x = ym("1938m10") + 300, 
    y = 13, 
    label = "established",
    color = "grey40",
    family = "Proxima Nova Rg",
    hjust = 0
  )

p1 


 

# p2 <- real_fed_mw %>% 
#   filter(name %in% c("diff_real")) %>% 
#   ggplot(aes(x = date, y = value, color = name)) +
#   scale_y_continuous(labels = scales::label_percent()) +
#   geom_line()
# 
# p1
# 
# plots <- align_plots(p1, p2, align="v")
#ggdraw(plots[[1]])
```
